package giaodien;
import giaodien.Login;
import java.awt.Color;
import java.sql.SQLException;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.swing.JOptionPane;

import connectDB.ConnectDB;
import dao.TaiKhoanDao;
import entity.TaiKhoan;

public class ChangePassword extends javax.swing.JFrame {


    public ChangePassword() throws SQLException{
        initComponents();
        ConnectDB.getInstance().getConnection();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        Right = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        Left = new javax.swing.JPanel();
        jLabel6 = new javax.swing.JLabel();
        txtTenDangNhap = new giaodien.CustomClass.TextField();
        btnDoiMatKhau = new giaodien.CustomClass.Button();
        button2 = new giaodien.CustomClass.Button();
        jLabel2 = new javax.swing.JLabel();
        txtMatKhauCu = new giaodien.CustomClass.PasswordField();
        txtMatKhauMoi1 = new giaodien.CustomClass.PasswordField();
        txtMatKhauMoi2 = new giaodien.CustomClass.PasswordField();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setTitle("ChangePassword");
        setResizable(false);

        jPanel1.setPreferredSize(new java.awt.Dimension(800, 500));
        jPanel1.setLayout(null);

        Right.setBackground(new java.awt.Color(255, 255, 255));
        Right.setPreferredSize(new java.awt.Dimension(400, 500));

        jLabel1.setIcon(new javax.swing.ImageIcon(getClass().getResource("/imgLogin/tien-sanh-khach-san.jpg"))); // NOI18N
        jLabel1.setText("jLabel1");
        jLabel1.setMaximumSize(new java.awt.Dimension(800, 600));
        jLabel1.setMinimumSize(new java.awt.Dimension(800, 600));
        jLabel1.setPreferredSize(new java.awt.Dimension(800, 600));

        javax.swing.GroupLayout RightLayout = new javax.swing.GroupLayout(Right);
        Right.setLayout(RightLayout);
        RightLayout.setHorizontalGroup(
            RightLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 400, Short.MAX_VALUE)
        );
        RightLayout.setVerticalGroup(
            RightLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(RightLayout.createSequentialGroup()
                .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 500, Short.MAX_VALUE)
                .addContainerGap())
        );

        jPanel1.add(Right);
        Right.setBounds(0, 0, 400, 500);

        Left.setBackground(new java.awt.Color(255, 255, 255));

        jLabel6.setFont(new java.awt.Font("Showcard Gothic", 0, 24)); // NOI18N
        jLabel6.setText("StaRail Hotel  Management");

        txtTenDangNhap.setFont(new java.awt.Font("Segoe UI", 0, 15)); // NOI18N
        txtTenDangNhap.setLabelText("Tên đăng nhập");
        txtTenDangNhap.setLineColor(new java.awt.Color(23, 195, 178));
        txtTenDangNhap.setPreferredSize(new java.awt.Dimension(240, 55));
        txtTenDangNhap.setSelectionColor(new java.awt.Color(23, 195, 178));

        btnDoiMatKhau.setBackground(new java.awt.Color(23, 195, 178));
        btnDoiMatKhau.setBorder(null);
        btnDoiMatKhau.setText("THAY ĐỔI");
        btnDoiMatKhau.setBorderColor(new java.awt.Color(23, 195, 178));
        btnDoiMatKhau.setColorOver(new java.awt.Color(0, 255, 204));
        btnDoiMatKhau.setFont(new java.awt.Font("Segoe UI", 1, 20)); // NOI18N
        btnDoiMatKhau.setPreferredSize(new java.awt.Dimension(125, 35));
        btnDoiMatKhau.setRadius(20);
        btnDoiMatKhau.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseExited(java.awt.event.MouseEvent evt) {
                btnDoiMatKhauMouseExited(evt);
            }
        });
        btnDoiMatKhau.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnDoiMatKhauActionPerformed(evt);
            }
        });

        button2.setBorder(null);
        button2.setText("Quay lại");
        button2.setBorderColor(java.awt.Color.white);
        button2.setColor(new java.awt.Color(254, 249, 239));
        button2.setRadius(15);
        button2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                button2ActionPerformed(evt);
            }
        });

        jLabel2.setBackground(new java.awt.Color(23, 195, 178));
        jLabel2.setFont(new java.awt.Font("Segoe UI", 1, 26)); // NOI18N
        jLabel2.setForeground(new java.awt.Color(23, 195, 178));
        jLabel2.setText("ĐỔI MẬT KHẨU");

        txtMatKhauCu.setFont(new java.awt.Font("Segoe UI", 0, 15)); // NOI18N
        txtMatKhauCu.setLabelText("Mật khẩu cũ");
        txtMatKhauCu.setLineColor(new java.awt.Color(23, 195, 178));

        txtMatKhauMoi1.setFont(new java.awt.Font("Segoe UI", 0, 15)); // NOI18N
        txtMatKhauMoi1.setLabelText("Mật khẩu mới");
        txtMatKhauMoi1.setLineColor(new java.awt.Color(23, 195, 178));

        txtMatKhauMoi2.setFont(new java.awt.Font("Segoe UI", 0, 15)); // NOI18N
        txtMatKhauMoi2.setLabelText("Mật khẩu mới");
        txtMatKhauMoi2.setLineColor(new java.awt.Color(23, 195, 178));

        javax.swing.GroupLayout LeftLayout = new javax.swing.GroupLayout(Left);
        Left.setLayout(LeftLayout);
        LeftLayout.setHorizontalGroup(
            LeftLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(LeftLayout.createSequentialGroup()
                .addGroup(LeftLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(LeftLayout.createSequentialGroup()
                        .addGap(27, 27, 27)
                        .addComponent(jLabel6))
                    .addGroup(LeftLayout.createSequentialGroup()
                        .addGap(80, 80, 80)
                        .addGroup(LeftLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(btnDoiMatKhau, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(txtTenDangNhap, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(txtMatKhauCu, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(txtMatKhauMoi1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(txtMatKhauMoi2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                    .addGroup(LeftLayout.createSequentialGroup()
                        .addGap(102, 102, 102)
                        .addComponent(jLabel2)))
                .addContainerGap(27, Short.MAX_VALUE))
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, LeftLayout.createSequentialGroup()
                .addGap(0, 0, Short.MAX_VALUE)
                .addComponent(button2, javax.swing.GroupLayout.PREFERRED_SIZE, 56, javax.swing.GroupLayout.PREFERRED_SIZE))
        );
        LeftLayout.setVerticalGroup(
            LeftLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(LeftLayout.createSequentialGroup()
                .addComponent(button2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(24, 24, 24)
                .addComponent(jLabel6)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(jLabel2, javax.swing.GroupLayout.PREFERRED_SIZE, 44, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(txtTenDangNhap, javax.swing.GroupLayout.PREFERRED_SIZE, 55, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(txtMatKhauCu, javax.swing.GroupLayout.PREFERRED_SIZE, 55, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(txtMatKhauMoi1, javax.swing.GroupLayout.PREFERRED_SIZE, 55, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(txtMatKhauMoi2, javax.swing.GroupLayout.PREFERRED_SIZE, 55, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(31, 31, 31)
                .addComponent(btnDoiMatKhau, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(38, 38, 38))
        );

        jPanel1.add(Left);
        Left.setBounds(400, 0, 400, 500);
        Left.getAccessibleContext().setAccessibleName("");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(0, 0, Short.MAX_VALUE))
        );

        pack();
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    private void btnDoiMatKhauMouseExited(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_btnDoiMatKhauMouseExited
        btnDoiMatKhau.setBackground(new Color(23,195,178));
    }//GEN-LAST:event_btnDoiMatKhauMouseExited

    private void txtMatKhauMoi1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtMatKhauMoi1ActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_txtMatKhauMoi1ActionPerformed

    private void button2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_button2ActionPerformed
        try {
            Login LoginFrame = new Login();
            LoginFrame.setVisible(true);
            LoginFrame.pack();
            LoginFrame.setLocationRelativeTo(null); // center
            this.dispose();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }//GEN-LAST:event_button2ActionPerformed
    
	private boolean regMatKhau(String matKhau) {
		String regex = "^(?=.*[A-Z])(?=.*\\d).{8,}$";

		Pattern pattern = Pattern.compile(regex);
		Matcher matcher = pattern.matcher(matKhau);

		return matcher.matches();
	}

    private void btnDoiMatKhauActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnDoiMatKhauActionPerformed
        try {
        // Lấy thông tin từ các trường nhập liệu
        String tenDangNhap = txtTenDangNhap.getText();
        String matKhauCu = new String(txtMatKhauCu.getPassword());
        String matKhauMoi1;
        String matKhauMoi2;

        // Kiểm tra xác thực đăng nhập
        TaiKhoanDao taiKhoanDao = new TaiKhoanDao();
        boolean dangNhapThanhCong = taiKhoanDao.xacThucDangNhap(tenDangNhap, matKhauCu);

        if (dangNhapThanhCong) {
            // Lặp lại quá trình nhập mật khẩu mới cho đến khi nó khác mật khẩu cũ
            boolean matKhauMoiKhacCu = false;
            do {
                matKhauMoi1 = new String(txtMatKhauMoi1.getPassword());
                matKhauMoi2 = new String(txtMatKhauMoi2.getPassword());

                if (!matKhauMoi1.equals(matKhauMoi2)) {
                    int option = JOptionPane.showOptionDialog(null, "Mật khẩu mới không trùng khớp", "Thông báo", JOptionPane.DEFAULT_OPTION, JOptionPane.WARNING_MESSAGE, null, new Object[]{"OK"}, "OK");
                    if (option == JOptionPane.OK_OPTION) {
                        return; // Thoát khỏi phương thức khi người dùng nhấn OK
                    }
                } else if (matKhauMoi1.equals(matKhauCu)) {
                    int option = JOptionPane.showOptionDialog(null, "Mật khẩu mới phải khác mật khẩu cũ", "Thông báo", JOptionPane.DEFAULT_OPTION, JOptionPane.WARNING_MESSAGE, null, new Object[]{"OK"}, "OK");
                    if (option == JOptionPane.OK_OPTION) {
                        return; // Thoát khỏi phương thức khi người dùng nhấn OK
                    }
                } else {
                    matKhauMoiKhacCu = true; // Mật khẩu mới khác mật khẩu cũ
                }
            } while (!matKhauMoi1.equals(matKhauMoi2) || !matKhauMoiKhacCu);

            // Cập nhật mật khẩu mới vào cơ sở dữ liệu
            TaiKhoan taiKhoan = new TaiKhoan();
            taiKhoan.setTenDangNhap(tenDangNhap);
            taiKhoan.setMatKhau(matKhauMoi1);
            boolean doiMatKhauThanhCong = taiKhoanDao.suaTaiKhoan(taiKhoan);
            if (doiMatKhauThanhCong) {
                JOptionPane.showMessageDialog(null, "Đổi mật khẩu thành công", "Thông báo", JOptionPane.INFORMATION_MESSAGE);
            } else {
                JOptionPane.showMessageDialog(null, "Đổi mật khẩu thất bại", "Thông báo", JOptionPane.ERROR_MESSAGE);
            }
        } else {
            // Đăng nhập thất bại
            JOptionPane.showMessageDialog(null, "Sai tên đăng nhập hoặc mật khẩu.", "Thông báo", JOptionPane.ERROR_MESSAGE);
        }
    } catch (Exception ex) {
        ex.printStackTrace();
    }
    }//GEN-LAST:event_btnDoiMatKhauActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel Left;
    private javax.swing.JPanel Right;
    private giaodien.CustomClass.Button btnDoiMatKhau;
    private giaodien.CustomClass.Button button2;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JPanel jPanel1;
    private giaodien.CustomClass.PasswordField txtMatKhauCu;
    private giaodien.CustomClass.PasswordField txtMatKhauMoi1;
    private giaodien.CustomClass.PasswordField txtMatKhauMoi2;
    private giaodien.CustomClass.TextField txtTenDangNhap;
    // End of variables declaration//GEN-END:variables
    
    public static void main(String[] args) {
		java.awt.EventQueue.invokeLater(new Runnable() {
			public void run() {
				try {
					new ChangePassword().setVisible(true);
				} catch (SQLException e) {
					e.printStackTrace();
				}
			}
		});
	}
}
